# Audit.NET.ImmuDB

**ImmuDB provider for [Audit.NET](https://github.com/thepirat000/Audit.NET)**  

Store audit events in an [ImmuDB](https://immudb.io/) database. 

ImmuDB is an immutable, tamper-evident database ideal for audit trails and compliance.  

See the [ImmuDB documentation](https://docs.immudb.io/) for more details.

## Install

**NuGet Package** 

```
PM> Install-Package Audit.NET.ImmuDB
```

[![NuGet Status](https://img.shields.io/nuget/v/Audit.NET.ImmuDB.svg?style=flat)](https://www.nuget.org/packages/Audit.NET.ImmuDB/)
[![NuGet Count](https://img.shields.io/nuget/dt/Audit.NET.ImmuDB.svg)](https://www.nuget.org/packages/Audit.NET.ImmuDB/)

## Usage
Please see the [Audit.NET Readme](https://github.com/thepirat000/Audit.NET#usage)

## Configuration
Set the static `Audit.Core.Configuration.DataProvider` property to set the Immu DB data provider, 
or call the `UseImmuDb` method on the fluent configuration. This should be done before any `AuditScope` creation, i.e. during application startup.
 
For example:

```c#
Audit.Core.Configuration.DataProvider = new ImmuDbDataProvider()
{
    ClientBuilderAction = b => b
        .WithServerUrl("localhost")
        .WithServerPort(3322)
        .WithDatabase("db")
        .WithCredentials("admin", "password"),
    UseVerifiedMethods = true,
    KeySelector = _ => Guid.NewGuid().ToByteArray()
};
```
Or by using the [fluent configuration API](https://github.com/thepirat000/Audit.NET#configuration-fluent-api):

```c#
Audit.Core.Configuration.Setup()
    .UseImmuDb(config => config
        .ClientBuilder(b => b
            .WithServerUrl("localhost")
            .WithServerPort(3322)
            .WithDatabase("db")
            .WithCredentials("admin", "password"))
        .UseVerifiedMethods()
        .KeySelector(_ => Guid.NewGuid().ToByteArray()));
```

You can also configure the provider to use different database and credentials based on an audit event criteria. For example:

```c#
Audit.Core.Configuration.Setup()
    .UseImmuDb(config => config
        .ClientBuilder(b => b
            .WithServerUrl("localhost")
            .WithServerPort(3322))
        .Database(auditEvent => auditEvent.EventType == "Http" ? "db1" : "db2")
        .Username(auditEvent => auditEvent.EventType == "Http" ? "user1" : "user2")
        .Password(auditEvent => auditEvent.EventType == "Http" ? "password1" : "password2")
        .UseVerifiedMethods()
        .KeySelector(_ => Guid.NewGuid().ToByteArray()));
```

The `key` used to store the audit event in the ImmuDB database is generated by the `KeySelector` function. If not specified, a random Guid is used.

The `value` stored in the ImmuDB database is generated by the `ValueSelector` function. If not specified, the serialized audit event in UTF8 JSON format is used. 

You can customize the value stored by providing a `ValueSelector` function that extracts the desired data from the audit event.

For example:

```c#
Audit.Core.Configuration.Setup()
    .UseImmuDb(config => config
        .ClientBuilder(b => b
            .WithServerUrl("localhost")
            .WithServerPort(3322)
            .WithDatabase("db")
            .WithCredentials("admin", "password"))
        .ValueSelector(auditEvent => $"{auditEvent.StartDate}: {auditEvent.EventType}"));
```

### Provider options
- `ClientBuilder`: A function to create the ImmuDB client. If not set, a client with the default settings will be used.
- `DatabaseName`: The name of the database to use when connecting to the ImmuDB server. If not specified, the value defined in the client builder is used, which defaults to "defaultdb".
- `Username`: The username to use when connecting to the ImmuDB server. If not specified, the value defined in the client builder is used, which defaults to "immudb".
- `Password`: The password to use when connecting to the ImmuDB server. If not specified, the value defined in the client builder is used, which defaults to "immudb".
- `KeySelector`: A function to select the key for the audit event. If not specified, the default key selector is used, which generates a unique key based on the event's ID.
- `ValueSelector`: A function to select the value to store from the audit event. If not specified, the default value selector is used, which serializes the event to UTF8 JSON format.
- `UseVerifiedMethods`: A boolean indicating whether to use verified methods for writing events. If set to `true`, uses verified writes for tamper-evidence. Default is false 
- `ExpirationTimeout`: An optional expiration timeout for the audit events. If set, the events will be automatically deleted after the specified time. The value is a `TimeSpan` representing the duration after which the event should expire. If not set, events will not expire.
